{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/noasohier/Desktop/travel-ia-pro/my-clerk-app/components/ItineraryBuilder.tsx"],"sourcesContent":["'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';\nimport { arrayMove, SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy, useSortable } from '@dnd-kit/sortable';\nimport { CSS } from '@dnd-kit/utilities';\nimport dynamic from 'next/dynamic';\n\n// Dynamic import for Map to avoid SSR issues\nconst ItineraryMap = dynamic(() => import('./ItineraryMap'), { ssr: false });\n\nfunction SortableItem(props: any) {\n    const {\n        attributes,\n        listeners,\n        setNodeRef,\n        transform,\n        transition,\n    } = useSortable({ id: props.id });\n\n    const style = {\n        transform: CSS.Transform.toString(transform),\n        transition,\n    };\n\n    return (\n        <div ref={setNodeRef} style={style} {...attributes} {...listeners} className=\"mb-4 cursor-grab active:cursor-grabbing\">\n            {props.children}\n        </div>\n    );\n}\n\nconst ItineraryBuilder = ({ itinerary, onUpdate, activeDayIndex, setActiveDayIndex }: any) => {\n    // Helper to get days array safely\n    const getDays = () => {\n        if (!itinerary || !itinerary.itineraire || !Array.isArray(itinerary.itineraire)) return [];\n        return itinerary.itineraire;\n    };\n\n    const days = getDays();\n    const activeDay = days[activeDayIndex];\n\n    // Adapter function to safely get steps for the CURRENT day\n    const getStepsForDay = (dayIndex: number) => {\n        const day = days[dayIndex];\n        if (!day) return [];\n\n        // CASE 1: New JSON Format (etapes array)\n        if (day.etapes && Array.isArray(day.etapes)) {\n            // Check if IDs already exist to avoid re-generating causing re-renders\n            return day.etapes.map((s: any, i: number) => ({ ...s, id: s.id || `step-${dayIndex}-${i}` }));\n        }\n\n        // CASE 2: Old JSON Format Fallback\n        const fallbackSteps = [];\n        if (day.matin) fallbackSteps.push({ id: `step-${dayIndex}-m`, heure: 'Matin', activite: day.matin, description: 'Activités du matin', coordinates: { lat: 48.85, lng: 2.35 } });\n        if (day.apres_midi) fallbackSteps.push({ id: `step-${dayIndex}-mid`, heure: 'Midi', activite: day.apres_midi, description: 'Activités de l\\'après-midi', coordinates: { lat: 48.86, lng: 2.34 } });\n        if (day.soir) fallbackSteps.push({ id: `step-${dayIndex}-s`, heure: 'Soir', activite: day.soir, description: 'Activités du soir', coordinates: { lat: 48.87, lng: 2.33 } });\n        return fallbackSteps;\n    };\n\n    // Initialize/Update steps when activeDay or itinerary changes\n    const [steps, setSteps] = useState(getStepsForDay(0));\n\n    useEffect(() => {\n        setSteps(getStepsForDay(activeDayIndex));\n    }, [activeDayIndex, itinerary]);\n\n\n    const sensors = useSensors(\n        useSensor(PointerSensor),\n        useSensor(KeyboardSensor, {\n            coordinateGetter: sortableKeyboardCoordinates,\n        })\n    );\n\n    const handleDragEnd = (event: any) => {\n        const { active, over } = event;\n        if (active.id !== over.id) {\n            setSteps((items: any) => {\n                const oldIndex = items.findIndex((i: any) => i.id === active.id);\n                const newIndex = items.findIndex((i: any) => i.id === over.id);\n                const newSteps = arrayMove(items, oldIndex, newIndex);\n\n                // Update Parent State (Persistence)\n                // We need to clone the itinerary deep enough to modify the specific day's steps\n                const updatedItinerary = { ...itinerary };\n                const updatedDays = [...updatedItinerary.itineraire];\n                const updatedDay = { ...updatedDays[activeDayIndex] };\n\n                updatedDay.etapes = newSteps;\n                updatedDays[activeDayIndex] = updatedDay;\n                updatedItinerary.itineraire = updatedDays;\n\n                // Call parent update\n                if (onUpdate) onUpdate(updatedItinerary);\n\n                return newSteps;\n            });\n        }\n    };\n\n    // Calculate Map Center for Active Day\n    const validCoords = steps.filter((s: any) => s.coordinates && s.coordinates.lat);\n    const mapCenter: [number, number] | null = validCoords.length > 0\n        ? [Number(validCoords[0].coordinates.lat), Number(validCoords[0].coordinates.lng)]\n        : null;\n\n    if (days.length === 0) return <div className=\"text-center text-slate-400\">Aucun itinéraire à afficher.</div>;\n\n    return (\n        <div className=\"flex flex-col h-full gap-6\">\n\n            {/* Day Navigator */}\n            <div className=\"flex items-center justify-between bg-white p-2 rounded-xl shadow-sm border border-slate-100\">\n                <button\n                    onClick={() => setActiveDayIndex(Math.max(0, activeDayIndex - 1))}\n                    disabled={activeDayIndex === 0}\n                    className=\"w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed transition\"\n                >\n                    <i className=\"fa-solid fa-chevron-left\"></i>\n                </button>\n\n                <div className=\"flex overflow-x-auto gap-2 px-2 no-scrollbar scroll-smooth\">\n                    {days.map((day: any, idx: number) => (\n                        <button\n                            key={idx}\n                            onClick={() => setActiveDayIndex(idx)}\n                            className={`whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold transition flex-shrink-0\n                                ${activeDayIndex === idx\n                                    ? 'bg-indigo-600 text-white shadow-md'\n                                    : 'bg-slate-50 text-slate-500 hover:bg-slate-100'\n                                }`}\n                        >\n                            {day.jour || `Jour ${idx + 1}`}\n                        </button>\n                    ))}\n                </div>\n\n                <button\n                    onClick={() => setActiveDayIndex(Math.min(days.length - 1, activeDayIndex + 1))}\n                    disabled={activeDayIndex === days.length - 1}\n                    className=\"w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed transition\"\n                >\n                    <i className=\"fa-solid fa-chevron-right\"></i>\n                </button>\n            </div>\n\n            <div className=\"flex flex-col lg:flex-row h-full gap-4\">\n                {/* List Panel (Draggable) */}\n                <div className=\"w-full lg:w-1/2\">\n                    <h3 className=\"text-xl font-bold mb-4 text-indigo-900 flex items-center gap-2\">\n                        <i className=\"fa-solid fa-list-check\"></i>\n                        {activeDay ? activeDay.jour : \"Programme\"}\n                        <span className=\"text-xs font-normal text-slate-400 ml-auto hidden sm:inline\">(Glissez pour réorganiser)</span>\n                    </h3>\n\n                    <div className=\"space-y-3\">\n                        <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>\n                            <SortableContext items={steps} strategy={verticalListSortingStrategy}>\n                                {steps.map((step: any) => (\n                                    <SortableItem key={step.id} id={step.id}>\n                                        <div className=\"bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition group relative flex gap-4\">\n                                            <div className=\"text-slate-300 mt-1 cursor-grab active:cursor-grabbing\">\n                                                <i className=\"fa-solid fa-grip-vertical\"></i>\n                                            </div>\n                                            <div className=\"flex-1\">\n                                                <div className=\"flex justify-between items-start mb-1\">\n                                                    <span className=\"text-xs font-bold uppercase text-indigo-500\">{step.heure}</span>\n                                                    <span className=\"text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full font-bold border border-indigo-100\">\n                                                        {step.activite}\n                                                    </span>\n                                                </div>\n                                                <p className=\"text-sm text-slate-600 leading-relaxed\">{step.description}</p>\n                                            </div>\n                                        </div>\n                                    </SortableItem>\n                                ))}\n                            </SortableContext>\n                        </DndContext>\n                        {steps.length === 0 && <p className=\"text-slate-400 italic text-center text-sm py-4\">Aucune étape détaillée pour ce jour.</p>}\n                    </div>\n                </div>\n\n                {/* Map Panel */}\n                <div className=\"w-full lg:w-1/2 h-80 lg:h-auto min-h-[400px] rounded-xl overflow-hidden shadow-inner border border-slate-200 relative z-0\">\n                    <ItineraryMap center={mapCenter} steps={steps} />\n                </div>\n            </div>\n        </div>\n    );\n};\n\nexport default ItineraryBuilder;\n"],"names":[],"mappings":"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"}}]
}