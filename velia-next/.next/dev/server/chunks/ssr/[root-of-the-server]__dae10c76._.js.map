{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///Users/noasohier/Desktop/travel-ia-pro/velia-next/app/actions.ts"],"sourcesContent":["'use server'\n\nimport { PrismaClient } from '@prisma/client'\nimport { auth } from '@clerk/nextjs/server'\n\nconst prisma = new PrismaClient()\n\n// --- AI GENERATION ---\nconst OPENROUTER_KEY = process.env.OPENROUTER_KEY;\n\nexport async function generateTrip(params: any) {\n  const { destination, rayon, budget, style, diet, adultes, enfants, animaux, depart, dates, vibes } = params;\n\n  // Recalculate duration if needed\n  let nombreJours = null;\n  if (dates && dates.depart && dates.retour) {\n    const start = new Date(dates.depart);\n    const end = new Date(dates.retour);\n    const diffTime = Math.abs(end.getTime() - start.getTime());\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n    if (!isNaN(diffDays) && diffDays > 0) {\n      nombreJours = diffDays;\n    }\n  }\n\n  const prompt = `Tu es une IA experte en voyage \"VELIA\".Réponds UNIQUEMENT au format JSON strict.\nAucun texte en dehors du JSON.Aucune phrase d'introduction.\n\nParamètres utilisateur:\n{\n  \"destination\": \"${destination}\",\n  \"rayon_decouverte\": \"${rayon > 0 ? rayon + ' km autour' : 'Ville uniquement'}\",\n  \"depart_lieu\": \"${depart}\",\n  \"dates\": \"${dates ? `Du ${dates.depart} au ${dates.retour}` : \"Non spécifiées\"}\",\n  \"duree_calculee\": \"${nombreJours ? nombreJours + ' Jours' : 'Non spécifié'}\",\n  \"budget\": \"${budget}\",\n  \"style\": \"${style}\",\n  \"vibes_niche\": \"${vibes ? vibes.join(', ') : 'Standard'}\",\n  \"diet\": \"${diet || 'Aucun régime spécifique'}\",\n  \"voyageurs\": { \"adultes\": ${adultes || 1}, \"enfants\": ${enfants || 0} },\n  \"animaux\": ${animaux ? '\"Oui\"' : '\"Non\"'}\n}\n\nINSTRUCTIONS SPECIFIQUES \"STYLE\":\nSi \"style\" contient:\n- \"Roadtrip Moto\": Propose des routes scéniques avec virages, parkings sécurisés pour les hôtels obligatoires, et des étapes adaptées aux motards (pauses café, points de vue).\n- \"Trekking\": Inclus des détails sur les sentiers (difficulté, durée), et privilégie les refuges ou hébergements proches de la nature.\n- \"Sportif\": Centre le voyage autour d'activités physiques intenses (vélo, kayak, rando, sale de sport) et une nutrition adaptée.\n\nIMPORTANT SUR LE RAYON:\nSi \"rayon_decouverte\" est supérieur à 0 km, tu PEUX et DOIS inclure des activités, restaurants ou visites situés dans ce rayon autour de la destination principale. Si c'est \"Ville uniquement\", reste strict.\n\nIMPORTANT SUR LA MÉTÉO:\nUtilise les dates fournies (${dates ? `Du ${dates.depart} au ${dates.retour}` : \"Mois inconnu\"}) pour estimer la météo probable (basée sur les normales saisonnières).\n\nStructure JSON attendue(STRICT) :\n{\n  \"destination\": \"string\",\n  \"meteo\": {\n    \"temp_min\": \"string (ex: 15°C)\",\n    \"temp_max\": \"string (ex: 22°C)\",\n    \"description\": \"string (ex: Ensoleillé avec averses possibles)\",\n    \"conseils\": \"string (ex: Prévoyez un imperméable)\"\n  },\n  \"budget_total_estime\": \"string\",\n  \"transports\": [\n    { \"type\": \"string\", \"compagnie\": \"string\", \"prix\": \"string\", \"lien\": \"string\" }\n  ],\n  \"hotels\": [\n    { \"nom\": \"string\", \"prix_par_nuit\": \"string\", \"avis\": \"string (ex: 4.5/5 sur Google)\", \"emplacement\": \"string\", \"lien\": \"string\", \"coordinates\": { \"lat\": number, \"lng\": number } }\n  ],\n  \"restaurants\": [\n    { \"nom\": \"string\", \"type\": \"string\", \"prix_moyen\": \"string\", \"avis\": \"string (ex: 4.7/5 sur TripAdvisor)\", \"lien\": \"string\", \"coordinates\": { \"lat\": number, \"lng\": number } }\n  ],\n  \"activites\": [\n    { \"nom\": \"string\", \"prix\": \"string\", \"description\": \"string\", \"avis\": \"string (ex: 4.8/5)\", \"lien\": \"string\", \"coordinates\": { \"lat\": number, \"lng\": number }, \"id\": \"string (unique)\" }\n  ],\n  \"itineraire\": [\n    {\n      \"jour\": \"Jour 1\",\n      \"etapes\": [\n        {\n          \"heure\": \"Matin\",\n          \"activite\": \"string\",\n          \"description\": \"string\",\n          \"coordinates\": { \"lat\": number, \"lng\": number }\n        }\n      ]\n    }\n  ]\n}\nGENERE BIEN TOUS LES JOURS DEMANDÉS (${nombreJours}).\n`;\n\n  // Call OpenRouter (similar logic to previous proxy.js)\n  try {\n    const response = await fetch(\"https://openrouter.ai/api/v1/chat/completions\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${OPENROUTER_KEY}`,\n        \"Content-Type\": \"application/json\",\n        \"HTTP-Referer\": \"http://localhost:3000\",\n        \"X-Title\": \"Travel Generator Next\"\n      },\n      body: JSON.stringify({\n        model: \"google/gemini-2.0-flash-exp:free\",\n        messages: [{ role: \"user\", content: prompt }]\n      })\n    });\n\n    if (!response.ok) throw new Error(\"API Error\");\n\n    const data = await response.json();\n    const content = data.choices[0].message.content;\n\n    // Clean JSON\n    let cleanText = content.replace(/```json/g, \"\").replace(/```/g, \"\").trim();\n    const firstBrace = cleanText.indexOf('{');\n    const lastBrace = cleanText.lastIndexOf('}');\n    if (firstBrace !== -1 && lastBrace !== -1) {\n      cleanText = cleanText.substring(firstBrace, lastBrace + 1);\n    }\n\n    return JSON.parse(cleanText);\n\n  } catch (e: any) {\n    console.error(e);\n    return { error: \"Generation failed\", details: e.message };\n  }\n}\n\n\n// --- DATABASE OPERATIONS ---\n\nexport async function saveTrip(destination: string, tripData: any, requestParams: any = {}) {\n  const { userId } = await auth();\n  if (!userId) throw new Error(\"Unauthorized\");\n\n  // Wrap content to include both result and params\n  const contentToSave = {\n    itinerary: tripData,\n    request: requestParams\n  };\n\n  return await prisma.trip.create({\n    data: {\n      userId,\n      destination,\n      content: JSON.stringify(contentToSave)\n    }\n  });\n}\n\nexport async function getTrips() {\n  const { userId } = await auth();\n  if (!userId) return []; // Return empty if not logged in\n\n  const trips = await prisma.trip.findMany({\n    where: { userId },\n    orderBy: { createdAt: 'desc' }\n  });\n\n  // Parse content back to JSON\n  return trips.map(t => ({ ...t, content: JSON.parse(t.content) }));\n}\n\nexport async function getTrip(id: string) {\n  const { userId } = await auth();\n  if (!userId) return null;\n\n  const trip = await prisma.trip.findUnique({\n    where: { id }\n  });\n\n  if (!trip || trip.userId !== userId) return null;\n\n  return { ...trip, content: JSON.parse(trip.content) };\n}\n\nexport async function deleteTrip(id: string) {\n  const { userId } = await auth();\n  if (!userId) throw new Error(\"Unauthorized\");\n\n  return await prisma.trip.deleteMany({\n    where: { id, userId } // Security: ensure user owns trip\n  });\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;AAEA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAE/B,wBAAwB;AACxB,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc;AAE1C,eAAe,aAAa,MAAW;IAC5C,MAAM,EAAE,WAAW,EAAE,KAAK,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG;IAErG,iCAAiC;IACjC,IAAI,cAAc;IAClB,IAAI,SAAS,MAAM,MAAM,IAAI,MAAM,MAAM,EAAE;QACzC,MAAM,QAAQ,IAAI,KAAK,MAAM,MAAM;QACnC,MAAM,MAAM,IAAI,KAAK,MAAM,MAAM;QACjC,MAAM,WAAW,KAAK,GAAG,CAAC,IAAI,OAAO,KAAK,MAAM,OAAO;QACvD,MAAM,WAAW,KAAK,IAAI,CAAC,WAAW,CAAC,OAAO,KAAK,KAAK,EAAE,KAAK;QAC/D,IAAI,CAAC,MAAM,aAAa,WAAW,GAAG;YACpC,cAAc;QAChB;IACF;IAEA,MAAM,SAAS,CAAC;;;;;kBAKA,EAAE,YAAY;uBACT,EAAE,QAAQ,IAAI,QAAQ,eAAe,mBAAmB;kBAC7D,EAAE,OAAO;YACf,EAAE,QAAQ,CAAC,GAAG,EAAE,MAAM,MAAM,CAAC,IAAI,EAAE,MAAM,MAAM,EAAE,GAAG,iBAAiB;qBAC5D,EAAE,cAAc,cAAc,WAAW,eAAe;aAChE,EAAE,OAAO;YACV,EAAE,MAAM;kBACF,EAAE,QAAQ,MAAM,IAAI,CAAC,QAAQ,WAAW;WAC/C,EAAE,QAAQ,0BAA0B;4BACnB,EAAE,WAAW,EAAE,aAAa,EAAE,WAAW,EAAE;aAC1D,EAAE,UAAU,UAAU,QAAQ;;;;;;;;;;;;;4BAaf,EAAE,QAAQ,CAAC,GAAG,EAAE,MAAM,MAAM,CAAC,IAAI,EAAE,MAAM,MAAM,EAAE,GAAG,eAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;qCAsC1D,EAAE,YAAY;AACnD,CAAC;IAEC,uDAAuD;IACvD,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,iDAAiD;YAC5E,QAAQ;YACR,SAAS;gBACP,iBAAiB,CAAC,OAAO,EAAE,gBAAgB;gBAC3C,gBAAgB;gBAChB,gBAAgB;gBAChB,WAAW;YACb;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP,UAAU;oBAAC;wBAAE,MAAM;wBAAQ,SAAS;oBAAO;iBAAE;YAC/C;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE,MAAM,IAAI,MAAM;QAElC,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,MAAM,UAAU,KAAK,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO;QAE/C,aAAa;QACb,IAAI,YAAY,QAAQ,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;QACxE,MAAM,aAAa,UAAU,OAAO,CAAC;QACrC,MAAM,YAAY,UAAU,WAAW,CAAC;QACxC,IAAI,eAAe,CAAC,KAAK,cAAc,CAAC,GAAG;YACzC,YAAY,UAAU,SAAS,CAAC,YAAY,YAAY;QAC1D;QAEA,OAAO,KAAK,KAAK,CAAC;IAEpB,EAAE,OAAO,GAAQ;QACf,QAAQ,KAAK,CAAC;QACd,OAAO;YAAE,OAAO;YAAqB,SAAS,EAAE,OAAO;QAAC;IAC1D;AACF;AAKO,eAAe,SAAS,WAAmB,EAAE,QAAa,EAAE,gBAAqB,CAAC,CAAC;IACxF,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,4MAAI;IAC7B,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAE7B,iDAAiD;IACjD,MAAM,gBAAgB;QACpB,WAAW;QACX,SAAS;IACX;IAEA,OAAO,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;QAC9B,MAAM;YACJ;YACA;YACA,SAAS,KAAK,SAAS,CAAC;QAC1B;IACF;AACF;AAEO,eAAe;IACpB,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,4MAAI;IAC7B,IAAI,CAAC,QAAQ,OAAO,EAAE,EAAE,gCAAgC;IAExD,MAAM,QAAQ,MAAM,OAAO,IAAI,CAAC,QAAQ,CAAC;QACvC,OAAO;YAAE;QAAO;QAChB,SAAS;YAAE,WAAW;QAAO;IAC/B;IAEA,6BAA6B;IAC7B,OAAO,MAAM,GAAG,CAAC,CAAA,IAAK,CAAC;YAAE,GAAG,CAAC;YAAE,SAAS,KAAK,KAAK,CAAC,EAAE,OAAO;QAAE,CAAC;AACjE;AAEO,eAAe,QAAQ,EAAU;IACtC,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,4MAAI;IAC7B,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;QACxC,OAAO;YAAE;QAAG;IACd;IAEA,IAAI,CAAC,QAAQ,KAAK,MAAM,KAAK,QAAQ,OAAO;IAE5C,OAAO;QAAE,GAAG,IAAI;QAAE,SAAS,KAAK,KAAK,CAAC,KAAK,OAAO;IAAE;AACtD;AAEO,eAAe,WAAW,EAAU;IACzC,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,4MAAI;IAC7B,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAE7B,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;QAClC,OAAO;YAAE;YAAI;QAAO,EAAE,kCAAkC;IAC1D;AACF;;;IAhLsB;IA4HA;IAmBA;IAaA;IAaA;;AAzKA,gQAAA;AA4HA,gQAAA;AAmBA,gQAAA;AAaA,gQAAA;AAaA,gQAAA"}},
    {"offset": {"line": 226, "column": 0}, "map": {"version":3,"sources":["file:///Users/noasohier/Desktop/travel-ia-pro/velia-next/node_modules/%40clerk/nextjs/dist/esm/app-router/server-actions.js"],"sourcesContent":["\"use server\";\nimport { cookies } from \"next/headers\";\nasync function invalidateCacheAction() {\n  void (await cookies()).delete(`__clerk_invalidate_cache_cookie_${Date.now()}`);\n}\nexport {\n  invalidateCacheAction\n};\n"],"names":[],"mappings":";;;;;;AACA;;;;;AACA,eAAe;IACb,KAAK,CAAC,MAAM,IAAA,2JAAO,GAAE,EAAE,MAAM,CAAC,CAAC,gCAAgC,EAAE,KAAK,GAAG,IAAI;AAC/E;;;;IAEE;;AAAA,gQAAA","ignoreList":[0]}},
    {"offset": {"line": 250, "column": 0}, "map": {"version":3,"sources":["file:///Users/noasohier/Desktop/travel-ia-pro/velia-next/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {formatMetadataHeaders as '7f6507df7e348170292adfbcd85ba32aa1258c3b8b'} from 'ACTIONS_MODULE0'\nexport {collectKeylessMetadata as '7f7b332aac23d0128fe11398dce5ecb603b4fe6037'} from 'ACTIONS_MODULE0'\nexport {deleteKeylessAction as '7f012e610514bd7a7cf8b4d28c3d65e0dee29e0183'} from 'ACTIONS_MODULE1'\nexport {syncKeylessConfigAction as '7f1b2ef535c36bea4fc48021ef96d3e0d0b87eb590'} from 'ACTIONS_MODULE1'\nexport {createOrReadKeylessAction as '7f4accc84a5efaa7e74f6b81c2b1d0bff04ab150b6'} from 'ACTIONS_MODULE1'\nexport {detectKeylessEnvDriftAction as '7f50b396118e3d782548ccf7db3fc8f409a73031ea'} from 'ACTIONS_MODULE1'\nexport {detectKeylessEnvDriftAction as '7f50b396118e3d782548ccf7db3fc8f409a73031ea'} from 'ACTIONS_MODULE1'\nexport {invalidateCacheAction as '7f9407716c8b62e1f73437a5b5e1c7d68cb9a0e36b'} from 'ACTIONS_MODULE2'\nexport {createOrReadKeylessAction as '7f4accc84a5efaa7e74f6b81c2b1d0bff04ab150b6'} from 'ACTIONS_MODULE1'\nexport {deleteKeylessAction as '7f012e610514bd7a7cf8b4d28c3d65e0dee29e0183'} from 'ACTIONS_MODULE1'\nexport {syncKeylessConfigAction as '7f1b2ef535c36bea4fc48021ef96d3e0d0b87eb590'} from 'ACTIONS_MODULE1'\nexport {generateTrip as '4042b9090c95c458c68636e6a853f795e9981e36cc'} from 'ACTIONS_MODULE3'\nexport {saveTrip as '70024431a4e8d6873d7ba37068d1f35a8add6d83d8'} from 'ACTIONS_MODULE3'\nexport {getTrip as '40b0581df05db84f98624c096d0ba5475972df6369'} from 'ACTIONS_MODULE3'\n"],"names":[],"mappings":";AAAA;AAEA;AAKA;AAIA"}}]
}