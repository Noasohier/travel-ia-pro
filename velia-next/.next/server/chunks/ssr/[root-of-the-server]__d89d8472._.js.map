{"version":3,"sources":["../../../../../velia-next/node_modules/%40clerk/nextjs/dist/esm/app-router/server-actions.js","../../../../../velia-next/app/actions.ts","../../../../../velia-next/.next-internal/server/app/dashboard/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\";\nimport { cookies } from \"next/headers\";\nasync function invalidateCacheAction() {\n  void (await cookies()).delete(`__clerk_invalidate_cache_cookie_${Date.now()}`);\n}\nexport {\n  invalidateCacheAction\n};\n","'use server'\n\nimport { PrismaClient } from '@prisma/client'\nimport { auth } from '@clerk/nextjs/server'\n\nconst prisma = new PrismaClient()\n\n// --- AI GENERATION ---\nconst OPENROUTER_KEY = process.env.OPENROUTER_KEY;\n\nexport async function generateTrip(params: any) {\n  const { destination, rayon, budget, style, diet, adultes, enfants, animaux, depart, dates, vibes } = params;\n\n  // Recalculate duration if needed\n  let nombreJours = null;\n  if (dates && dates.depart && dates.retour) {\n    const start = new Date(dates.depart);\n    const end = new Date(dates.retour);\n    const diffTime = Math.abs(end.getTime() - start.getTime());\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n    if (!isNaN(diffDays) && diffDays > 0) {\n      nombreJours = diffDays;\n    }\n  }\n\n  const prompt = `Tu es une IA experte en voyage \"VELIA\".Réponds UNIQUEMENT au format JSON strict.\nAucun texte en dehors du JSON.Aucune phrase d'introduction.\n\nParamètres utilisateur:\n{\n  \"destination\": \"${destination}\",\n  \"rayon_decouverte\": \"${rayon > 0 ? rayon + ' km autour' : 'Ville uniquement'}\",\n  \"depart_lieu\": \"${depart}\",\n  \"dates\": \"${dates ? `Du ${dates.depart} au ${dates.retour}` : \"Non spécifiées\"}\",\n  \"duree_calculee\": \"${nombreJours ? nombreJours + ' Jours' : 'Non spécifié'}\",\n  \"budget\": \"${budget}\",\n  \"style\": \"${style}\",\n  \"vibes_niche\": \"${vibes ? vibes.join(', ') : 'Standard'}\",\n  \"diet\": \"${diet || 'Aucun régime spécifique'}\",\n  \"voyageurs\": { \"adultes\": ${adultes || 1}, \"enfants\": ${enfants || 0} },\n  \"animaux\": ${animaux ? '\"Oui\"' : '\"Non\"'}\n}\n\nINSTRUCTIONS SPECIFIQUES \"STYLE\":\nSi \"style\" contient:\n- \"Roadtrip Moto\": Propose des routes scéniques avec virages, parkings sécurisés pour les hôtels obligatoires, et des étapes adaptées aux motards (pauses café, points de vue).\n- \"Trekking\": Inclus des détails sur les sentiers (difficulté, durée), et privilégie les refuges ou hébergements proches de la nature.\n- \"Sportif\": Centre le voyage autour d'activités physiques intenses (vélo, kayak, rando, sale de sport) et une nutrition adaptée.\n\nIMPORTANT SUR LE RAYON:\nSi \"rayon_decouverte\" est supérieur à 0 km, tu PEUX et DOIS inclure des activités, restaurants ou visites situés dans ce rayon autour de la destination principale. Si c'est \"Ville uniquement\", reste strict.\n\nIMPORTANT SUR LA MÉTÉO:\nUtilise les dates fournies (${dates ? `Du ${dates.depart} au ${dates.retour}` : \"Mois inconnu\"}) pour estimer la météo probable (basée sur les normales saisonnières).\n\nStructure JSON attendue(STRICT) :\n{\n  \"destination\": \"string\",\n  \"meteo\": {\n    \"temp_min\": \"string (ex: 15°C)\",\n    \"temp_max\": \"string (ex: 22°C)\",\n    \"description\": \"string (ex: Ensoleillé avec averses possibles)\",\n    \"conseils\": \"string (ex: Prévoyez un imperméable)\"\n  },\n  \"budget_total_estime\": \"string\",\n  \"transports\": [\n    { \"type\": \"string\", \"compagnie\": \"string\", \"prix\": \"string\", \"lien\": \"string\" }\n  ],\n  \"hotels\": [\n    { \"nom\": \"string\", \"prix_par_nuit\": \"string\", \"avis\": \"string (ex: 4.5/5 sur Google)\", \"emplacement\": \"string\", \"lien\": \"string\", \"coordinates\": { \"lat\": number, \"lng\": number } }\n  ],\n  \"restaurants\": [\n    { \"nom\": \"string\", \"type\": \"string\", \"prix_moyen\": \"string\", \"avis\": \"string (ex: 4.7/5 sur TripAdvisor)\", \"lien\": \"string\", \"coordinates\": { \"lat\": number, \"lng\": number } }\n  ],\n  \"activites\": [\n    { \"nom\": \"string\", \"prix\": \"string\", \"description\": \"string\", \"avis\": \"string (ex: 4.8/5)\", \"lien\": \"string\", \"coordinates\": { \"lat\": number, \"lng\": number }, \"id\": \"string (unique)\" }\n  ],\n  \"itineraire\": [\n    {\n      \"jour\": \"Jour 1\",\n      \"etapes\": [\n        {\n          \"heure\": \"Matin\",\n          \"activite\": \"string\",\n          \"description\": \"string\",\n          \"coordinates\": { \"lat\": number, \"lng\": number }\n        }\n      ]\n    }\n  ]\n}\nGENERE BIEN TOUS LES JOURS DEMANDÉS (${nombreJours}).\n`;\n\n  // Call OpenRouter (similar logic to previous proxy.js)\n  try {\n    const response = await fetch(\"https://openrouter.ai/api/v1/chat/completions\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${OPENROUTER_KEY}`,\n        \"Content-Type\": \"application/json\",\n        \"HTTP-Referer\": \"http://localhost:3000\",\n        \"X-Title\": \"Travel Generator Next\"\n      },\n      body: JSON.stringify({\n        model: \"google/gemini-2.0-flash-exp:free\",\n        messages: [{ role: \"user\", content: prompt }]\n      })\n    });\n\n    if (!response.ok) throw new Error(\"API Error\");\n\n    const data = await response.json();\n    const content = data.choices[0].message.content;\n\n    // Clean JSON\n    let cleanText = content.replace(/```json/g, \"\").replace(/```/g, \"\").trim();\n    const firstBrace = cleanText.indexOf('{');\n    const lastBrace = cleanText.lastIndexOf('}');\n    if (firstBrace !== -1 && lastBrace !== -1) {\n      cleanText = cleanText.substring(firstBrace, lastBrace + 1);\n    }\n\n    return JSON.parse(cleanText);\n\n  } catch (e: any) {\n    console.error(e);\n    return { error: \"Generation failed\", details: e.message };\n  }\n}\n\n\n// --- DATABASE OPERATIONS ---\n\nexport async function saveTrip(destination: string, tripData: any, requestParams: any = {}) {\n  const { userId } = await auth();\n  if (!userId) throw new Error(\"Unauthorized\");\n\n  // Wrap content to include both result and params\n  const contentToSave = {\n    itinerary: tripData,\n    request: requestParams\n  };\n\n  return await prisma.trip.create({\n    data: {\n      userId,\n      destination,\n      content: JSON.stringify(contentToSave)\n    }\n  });\n}\n\nexport async function getTrips() {\n  const { userId } = await auth();\n  if (!userId) return []; // Return empty if not logged in\n\n  const trips = await prisma.trip.findMany({\n    where: { userId },\n    orderBy: { createdAt: 'desc' }\n  });\n\n  // Parse content back to JSON\n  return trips.map(t => ({ ...t, content: JSON.parse(t.content) }));\n}\n\nexport async function getTrip(id: string) {\n  const { userId } = await auth();\n  if (!userId) return null;\n\n  const trip = await prisma.trip.findUnique({\n    where: { id }\n  });\n\n  if (!trip || trip.userId !== userId) return null;\n\n  return { ...trip, content: JSON.parse(trip.content) };\n}\n\nexport async function deleteTrip(id: string) {\n  const { userId } = await auth();\n  if (!userId) throw new Error(\"Unauthorized\");\n\n  return await prisma.trip.deleteMany({\n    where: { id, userId } // Security: ensure user owns trip\n  });\n}\n","export {detectKeylessEnvDriftAction as '7fd1e0bd57eb2ed0e95a70a0286c3e5a752e6b39df'} from 'ACTIONS_MODULE0'\nexport {invalidateCacheAction as '7f2c0ebc90fd5ec9b92b159ff09b0099247b5ea41d'} from 'ACTIONS_MODULE1'\nexport {createOrReadKeylessAction as '7f7142aac1f773b029fff2e9a3fa3ef3edc9b34673'} from 'ACTIONS_MODULE0'\nexport {formatMetadataHeaders as '7f315e1a761393951967292c26e538ccb5c9773ba8'} from 'ACTIONS_MODULE2'\nexport {collectKeylessMetadata as '7f61115a14a0c2c7d9c10ecdb58f4f8f47339cdf03'} from 'ACTIONS_MODULE2'\nexport {syncKeylessConfigAction as '7f0dd359250b3f2d507f436ce14ec5e75130a17a6b'} from 'ACTIONS_MODULE0'\nexport {createOrReadKeylessAction as '7f7142aac1f773b029fff2e9a3fa3ef3edc9b34673'} from 'ACTIONS_MODULE0'\nexport {deleteKeylessAction as '7fa18068bd2cc59494f692e51d964b82a274da0395'} from 'ACTIONS_MODULE0'\nexport {detectKeylessEnvDriftAction as '7fd1e0bd57eb2ed0e95a70a0286c3e5a752e6b39df'} from 'ACTIONS_MODULE0'\nexport {deleteKeylessAction as '7fa18068bd2cc59494f692e51d964b82a274da0395'} from 'ACTIONS_MODULE0'\nexport {syncKeylessConfigAction as '7f0dd359250b3f2d507f436ce14ec5e75130a17a6b'} from 'ACTIONS_MODULE0'\nexport {getTrips as '00791521a37011d22bdecd8958a21f2449acb2308e'} from 'ACTIONS_MODULE3'\nexport {generateTrip as '40326cbb478a59c0acbbce3edc3c2391643547a471'} from 'ACTIONS_MODULE3'\nexport {getTrip as '40b54362c01fc485ae9ef1d83d3f1bb6dad58a060f'} from 'ACTIONS_MODULE3'\nexport {deleteTrip as '40bc1fab7c4a751f1dfb5a459f4b4a41fe4162c04c'} from 'ACTIONS_MODULE3'\nexport {saveTrip as '70ccd64c840fc4201baefdc289c9d39ebf40ac8f32'} from 'ACTIONS_MODULE3'\n"],"names":[],"mappings":"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","ignoreList":[0]}